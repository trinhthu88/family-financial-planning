// Step 4: Calculation and Submission
function Step4({ formData, setFormData, onCalculateAndSubmit, onPrev }) {
  const handleChange = (e) => {
    const { name, value } = e.target;
    setFormData({ ...formData, [name]: value });
  };

  return (
    <div className="step active" id="step4">
      <h2>Step 4: Calculation</h2>
      <label>
        What percentage of the total education cost do you want to cover?<br />
        (e.g., 100 for full coverage, 50 for half):<br />
        <input
          type="number"
          name="coveragePercent"
          value={formData.coveragePercent || ''}
          onChange={handleChange}
        />
      </label>
      <br />
      <button onClick={onPrev}>Back</button>
      <button onClick={onCalculateAndSubmit}>Calculate and Submit</button>
    </div>
  );
}

// Results Component to display the calculated results
function Results({ results }) {
  return (
    <div className="result">
      <h2>Calculation Results</h2>
      <p><strong>Debt Coverage:</strong> {results.debtCoverage}</p>
      <p><strong>Education Coverage:</strong> {results.educationCoverage}</p>
      <p><strong>Living Cost Coverage:</strong> {results.livingCostCoverage}</p>
      <p><strong>Total Insurance Cover Required:</strong> {results.totalCover}</p>
    </div>
  );
}

// Main Calculator Component
function CalculatorApp() {
  const [step, setStep] = useState(1);
  const [formData, setFormData] = useState({});
  const [results, setResults] = useState(null);

  const nextStep = () => setStep(step + 1);
  const prevStep = () => setStep(step - 1);

  const calculateAndSubmit = () => {
    // Calculate Debt Coverage
    let debtCoverage = 0;
    if (formData.insuranceNeeds && formData.insuranceNeeds.includes('clearDebts')) {
      (formData.debts || []).forEach(debt => {
        debtCoverage += parseFloat(debt.amount || 0);
      });
    }

    // Calculate Education Coverage
    let educationCoverage = 0;
    if (formData.insuranceNeeds && formData.insuranceNeeds.includes('education')) {
      (formData.educationCosts || []).forEach(cost => {
        educationCoverage += parseFloat(cost || 0);
      });
    }

    // Calculate Living Cost Coverage
    let livingCostCoverage = 0;
    if (formData.insuranceNeeds && formData.insuranceNeeds.includes('livingCosts')) {
      const annualLiving = parseFloat(formData.livingCost || 0);
      const years = parseFloat(formData.livingCostYears || 0);
      livingCostCoverage = annualLiving * years;
    }

    // Sum up required cover components
    const totalRequired = debtCoverage + educationCoverage + livingCostCoverage;
    const currentSavings = parseFloat(formData.currentSavings || 0);
    const totalCoverRequired = Math.max(totalRequired - currentSavings, 0);

    // Formatting the results
    const calcResults = {
      debtCoverage: formatNumber(debtCoverage),
      educationCoverage: formatNumber(educationCoverage),
      livingCostCoverage: formatNumber(livingCostCoverage),
      totalCover: formatNumber(totalCoverRequired),
    };

    setResults(calcResults);

    // Prepare data for submission
    const participantName = localStorage.getItem('participantName') || '';
    const participantEmail = localStorage.getItem('participantEmail') || '';
    const data = {
      participantName,
      participantEmail,
      lifeInsuranceData: formData,
      results: calcResults,
    };

    // Submit the data to Formspree
    fetch("https://formspree.io/f/meoalyae", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(data)
    })
      .then(response => response.json())
      .then(data => {
        console.log("Submission Success:", data);
        alert("Calculation completed and submitted successfully!");
      })
      .catch((error) => {
        console.error("Submission Error:", error);
        alert("An error occurred during submission.");
      });
  };

  const renderStep = () => {
    switch (step) {
      case 1:
        return <Step1 formData={formData} setFormData={setFormData} onNext={nextStep} />;
      case 2:
        return <Step2 formData={formData} setFormData={setFormData} onNext={nextStep} onPrev={prevStep} />;
      case 3:
        return <Step3 formData={formData} setFormData={setFormData} onNext={nextStep} onPrev={prevStep} />;
      case 4:
        return <Step4 formData={formData} setFormData={setFormData} onCalculateAndSubmit={calculateAndSubmit} onPrev={prevStep} />;
      default:
        return <div>Invalid step</div>;
    }
  };

  return (
    <div className="App">
      <h1>Life Insurance Coverage Calculator</h1>
      {renderStep()}
      {results && <Results results={results} />}
    </div>
  );
}

ReactDOM.render(<CalculatorApp />, document.getElementById('root'));
